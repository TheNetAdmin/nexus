\RequirePackage{xkeyval}
\RequirePackage{tikz}
\RequirePackage{amssymb}
\RequirePackage{framed}
\usetikzlibrary{decorations.pathmorphing,calc}
\pgfdeclarelayer{background}
\pgfsetlayers{background,main}
\pgfmathsetseed{1} % To have predictable results


\define@key{boxedtheorem}{titlecolor}{\def\titlecolor{#1}}
\define@key{boxedtheorem}{titlebackground}{\def\titlebackground{#1}}
\define@key{boxedtheorem}{background}{\def\background{#1}}
\define@key{boxedtheorem}{titleboxcolor}{\def\titleboxcolor{#1}}
\define@key{boxedtheorem}{boxcolor}{\def\boxcolor{#1}}
\define@key{boxedtheorem}{thcounter}{\def\thcounter{#1}}
\define@key{boxedtheorem}{size}{\def\size{#1}}
\presetkeys{boxedtheorem}{titlecolor = black, titlebackground = white, background = white,%
                         titleboxcolor = black, boxcolor = black, thcounter=, size = .9\textwidth}{}

\newcommand{\couleurs}[1][]{%
    \setkeys{boxedtheorem}{#1}
    \tikzstyle{fancytitle} =[draw=\titleboxcolor, fill=\titlebackground,
                            text= \titlecolor]
    \tikzstyle{mybox} = [draw=\boxcolor, fill=\background, very thick,
                        rectangle, thick, inner sep=10pt, inner ysep=20pt]
    \tikzstyle{myformulabox} = [draw=\boxcolor, fill=\background, very thick,
                        rectangle, thick, inner sep=10pt]
}

%Style tracé main gros cadre
\pgfdeclaredecoration{penciline}{initial}{
    \state{initial}[width=+\pgfdecoratedinputsegmentremainingdistance,auto corner on length=1mm,]{
        \pgfpathcurveto%
        {% From
            \pgfqpoint{\pgfdecoratedinputsegmentremainingdistance}
                            {\pgfdecorationsegmentamplitude}
        }
        {%  Control 1
        \pgfmathrand
        \pgfpointadd{\pgfqpoint{\pgfdecoratedinputsegmentremainingdistance}{0pt}}
                        {\pgfqpoint{-\pgfdecorationsegmentaspect\pgfdecoratedinputsegmentremainingdistance}%
                                        {\pgfmathresult\pgfdecorationsegmentamplitude}
                        }
        }
        {%TO 
        \pgfpointadd{\pgfpointdecoratedinputsegmentlast}{\pgfpoint{1pt}{1pt}}
        }
    }
    \state{final}{}
}

%Style tracé main petit cadre (titre)
\pgfdeclaredecoration{penciline2}{initial}{
    \state{initial}[width=+\pgfdecoratedinputsegmentremainingdistance,auto corner on length=1mm,]{
        \pgfpathcurveto%
        {% From
            \pgfqpoint{\pgfdecoratedinputsegmentremainingdistance}
                            {\pgfdecorationsegmentamplitude}
        }
        {%  Control 1
        \pgfmathrand
        \pgfpointadd{\pgfqpoint{\pgfdecoratedinputsegmentremainingdistance}{0pt}}
                        {\pgfqpoint{-\pgfdecorationsegmentaspect\pgfdecoratedinputsegmentremainingdistance}%
                                        {\pgfmathresult\pgfdecorationsegmentamplitude}
                        }
        }
        {%TO 
        \pgfpointadd{\pgfpointdecoratedinputsegmentlast}{\pgfpoint{1pt}{1pt}}
        }
    }
    \state{final}{}
}

%Commande générique pour faire un joli encadré
\newsavebox{\boiboite}
\newcommand{\titre}{Titre}
\newenvironment{boite}[2][]%
    {%
    \renewcommand{\titre}{#2}
    \couleurs[#1]
    \begin{lrbox}{\boiboite}%
     \begin{minipage}[!h]{\size}
    }%
    {%
     \end{minipage}
    \end{lrbox}
    \begin{center}
    \begin{tikzpicture}[decoration=penciline]
    \node [mybox, decorate] (box){\usebox{\boiboite}};
    \node[fancytitle, decorate, right=10pt] at (box.north west) {\titre};
    \end{tikzpicture}
    \end{center}
    }




\newcommand{\newboxedtheorem}[4][]{%
    \couleurs[#1]
    \@ifnotempty{#4}{%
      \@ifundefined{the#4}{\@ifundefined{\thcounter}{\newcounter{#4}}{%
      \newcounter{#4}[\thcounter ] } } { }%
    }
    \newenvironment{#2}[1][]{%
    \@ifnotempty{#4}{\refstepcounter{#4}}
    \begin{boite}[#1]{{\large\fonthand#3\@ifnotempty{#4}{ \csname the#4\endcsname}}\@ifnotempty{##1}{
    \large\fonthand(##1)}}
    }%
    {%
    \end{boite}
    }
}

%%%%%%%%%%%%%%%%% Boiboite sans titre

\newsavebox{\boiboitedeux}
\newenvironment{formules}[1][]%
    {%
    \couleurs[#1]
    \begin{lrbox}{\boiboitedeux}%
     \begin{minipage}[!h]{\size}
    }%
    {%
     \end{minipage}
    \end{lrbox}
    \begin{center}
    \begin{tikzpicture}[decoration=penciline]
    \node [myformulabox, decorate] (box){\usebox{\boiboitedeux}};
    \end{tikzpicture}
    \end{center}
    }

    
    
%%%%%%%%%%%%%
% define styles for the normal border and the torn border
\tikzset{%
  normal border/.style={black, decorate, very thick,%
     decoration={random steps, segment length=2.5cm, amplitude=.5mm}}}%

% Macro to draw the shape behind the text, when it fits completly in the
% page
\def\parchmentframe#1{%
\tikz{%
  \node[inner xsep=1.1em] (A) {#1};% Draw the text of the node
  \begin{pgfonlayer}{background}% Draw the shape behind
  \draw[normal border]%
        (A.north west) -- (A.south west);%
  \end{pgfonlayer}}}%

% Macro to draw the shape, when the text will continue in next page
\def\parchmentframetop#1{%
\tikz{%
  \node[inner xsep=1.1em] (A) {#1};%    % Draw the text of the node
  \begin{pgfonlayer}{background}%    
  \draw[normal border]% 
        (A.north west) -- (A.south west);%
  \end{pgfonlayer}}}%

% Macro to draw the shape, when the text continues from previous page
\def\parchmentframebottom#1{%
\tikz{%
  \node[inner xsep=1.1em] (A) {#1};%   % Draw the text of the node
  \begin{pgfonlayer}{background}%   
  \draw[normal border]% 
        (A.north west) -- (A.south west);%
  \end{pgfonlayer}}%
  }%

% Macro to draw the shape, when both the text continues from previous page
% and it will continue in next page
\def\parchmentframemiddle#1{%
\tikz{%
  \node[inner xsep=1.1em] (A) {#1};%   % Draw the text of the node
  \begin{pgfonlayer}{background}%   
  \draw[normal border]% 
        (A.north west) -- (A.south west);%
  \end{pgfonlayer}}}%

% Define the environment which puts the frame
% In this case, the environment also accepts an argument with an optional
% title (which defaults to ``Example'', which is typeset in a box overlaid
% on the top border
\newenvironment{method}[1][Method]{%
  \def\FrameCommand{\parchmentframe}%
  \def\FirstFrameCommand{\parchmentframetop}%
  \def\LastFrameCommand{\parchmentframebottom}%
  \def\MidFrameCommand{\parchmentframemiddle}%
  \vskip\baselineskip%
  \MakeFramed {\FrameRestore}%
  \noindent\tikz\node[inner sep=1ex,,fill=white, %
          anchor=west, overlay] at (-2em, 2em) {\large\fonthand#1};%
    \tikz\node[anchor=west, overlay] at (-1.95cm,-.3cm)%
        {\includegraphics[width=1cm]{dessins/bulb}};%
  \ignorespaces%
  }%
{\endMakeFramed\medskip}%

\newcounter{beamer}[chapter]
\newenvironment{beamer}[1][Beamer]{%
  \refstepcounter{beamer}%
  \def\FrameCommand{\parchmentframe}%
  \def\FirstFrameCommand{\parchmentframetop}%
  \def\LastFrameCommand{\parchmentframebottom}%
  \def\MidFrameCommand{\parchmentframemiddle}%
  \vskip\baselineskip%
  \MakeFramed{\FrameRestore}%
  \noindent\tikz%
    \node[inner sep=1ex,fill=white, %
          anchor=west, overlay] at (-2em, 2em)%
          {\large\fonthand#1 \arabic{chapter}.\arabic{beamer}};%
    \tikz\node[anchor=west, overlay] at (-2.2cm,0cm)%
        {\includegraphics[width=1.2cm]{dessins/poisson}};%
  \ignorespaces%
  }%
{\endMakeFramed\medskip}%